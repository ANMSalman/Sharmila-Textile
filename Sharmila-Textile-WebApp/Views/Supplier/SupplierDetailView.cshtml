@if (ViewBag.IsUpdate == "true") {
    @model Sharmila_Textile_WebApp.ViewModel.SupplierViewModel;
}

@{
    ViewData["Title"] = "SupplierDetailView";
}

<nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
    <div class="container-fluid">
        <div class="navbar-wrapper">
            <nav aria-label="breadcrumb" role="navigation">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="SupplierView">Supplier</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@ViewBag.breadcumValue</li>
                </ol>
            </nav>
        </div>
        <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end">

            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="material-icons">notifications</i>
                        @* <span class="notification">5</span> *@
                        <p class="d-lg-none d-md-block">
                            Some Actions
                        </p>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="#">Mike John responded to your email</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" href="#" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="material-icons">person</i>
                        <p class="d-lg-none d-md-block">
                            Account
                        </p>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                        <a class="dropdown-item" href="#">Profile</a>
                        <a class="dropdown-item" href="#">Settings</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Log out</a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>


<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <hr />
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card h-100 ">
                    <div class="card-header card-header-primary">
                        <h4 class="card-title">Supplier Details</h4>
                    </div>
                    <div class="card-body">

                        <div class="row h-100">
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtSupplierName">Supplier Name</label>
                                    <input type="text" class="form-control" id="txtSupplierName" asp-for="SupplierName">
                                    <div class="text-danger" id="errorSupplierName"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtAddress">Address</label>
                                    <input type="text" class="form-control" id="txtAddress" asp-for="Address">
                                    <div class="text-danger" id="errorAddress"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtLandline">Landline</label>
                                    <input type="text" class="form-control" id="txtLandline" asp-for="Landline">
                                    <div class="text-danger" id="errorLandline"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtMobile">Mobile</label>
                                    <input type="text" class="form-control" id="txtMobile" asp-for="Mobile">
                                    <div class="text-danger" id="errorMobile"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtOpeningBalance">Opening Balance</label>
                                    <input type="number" class="form-control" id="txtOpeningBalance" asp-for="OpeningBalance">
                                    <div class="text-danger" id="errorOpeningBalance"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtCurrentBalance">Current Balance</label>
                                    <input type="number" class="form-control" id="txtCurrentBalance" asp-for="CurrentBalance">
                                    <div class="text-danger" id="errorCurrentBalance"></div>
                                </div>
                            </div>

                            <div class="col-md-5 mt-3">
                                <input type="file" id="fileAttachment" class="d-none">
                                <label for="fileAttachment" class="btn btn-round btn-success btn-sm mt-0">
                                    <i class="fa fa-cloud-upload mr-1"></i> Upload File
                                </label>
                                <hr />
                                <div class="mt-3">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <td class="font-weight-bold" width="70%">File Name</td>
                                                <td class="font-weight-bold text-center" width="15%">View File</td>
                                                <td class="font-weight-bold text-center" width="15%">Remove</td>
                                            </tr>
                                        </thead>
                                        <tbody id="selectedImageList">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-12 mt-3 align-self-end">
                                <button type="button" class="btn btn-primary float-right" onclick="getFieldDetails()">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    var fileObject = [];
    var fileCount = 0;

    $('#pnlUser').hide();

    var IsUpdate = @ViewBag.IsUpdate;
    var supplierId;

    @if (ViewBag.IsUpdate == "true") {
        @:supplierId = @Model.SupplierId;
        var attachmentCount = false || Model.SupplierAttachmentList.Count > 0;
        if (attachmentCount) {
            foreach (var item in Model.SupplierAttachmentList) {

                @:var baseFile = '@Html.Raw(item.AttachmentFile)';
                @:populateFileObjectArray(baseFile, "@item.AttachmentName");
            }
        }
    }

    function populateFileObjectArray(base64String, fileName) {

        var listHtml = `
                        <tr>
                            <td class="  p-1">`+ fileName + `</td>
                            <td class="text-center p-1">
                                <button type="button" rel="tooltip" class="btn btn-info btn-sm" onclick="openFileInNewTab('`+base64String+`');">
                                    <i class="material-icons">visibility</i>
                                </button>
                            </td>
                            <td class="text-center p-1">
                                <button type="button" rel="tooltip" class="btn btn-danger btn-sm" onclick="removeFileFromArray(`+ fileCount + `)">
                                    <i class="material-icons">clear</i>
                                </button>
                            </td>
                        </tr>
                        `;
        var obj = { count: fileCount, filesBase64: base64String, listHtml: listHtml, fileName: fileName };
        fileObject.push(obj);

        $('#selectedImageList').html(fileObject.map(e => e.listHtml).join(""));
        fileCount++;
    }

    $('input[id="fileAttachment"]').change(function (e) {
        if (fileObject.length < 5) {
            populateFilesList(e.target.files[0]);
        } else {
            Swal.fire(
                'File Limit Reached!',
                'You cannot select more than 5 files!',
                'error'
            );
        }
    });

    function populateFilesList(file) {
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () {
            var filesBase64 = reader.result;

            var listHtml = `
                            <tr>
                                <td class="  p-1">`+ file.name + `</td>
                                <td class="text-center p-1">
                                    <button type="button" rel="tooltip" class="btn btn-info btn-sm" onclick="openFileInNewTab('`+filesBase64+`');">
                                        <i class="material-icons">visibility</i>
                                    </button>
                                </td>
                                <td class="text-center p-1">
                                    <button type="button" rel="tooltip" class="btn btn-danger btn-sm" onclick="removeFileFromArray(`+ fileCount + `)">
                                        <i class="material-icons">clear</i>
                                    </button>
                                </td>
                            </tr>
                            `;

            var obj = { count: fileCount, filesBase64: filesBase64, listHtml: listHtml, fileName: file.name };
            fileObject.push(obj);

            $('#selectedImageList').html(fileObject.map(e => e.listHtml).join(""));
            fileCount++;
        };
        reader.onerror = function (error) {
            console.log('Error: ', error);
        };
    }

    function openFileInNewTab(file) {
        window.open(file);
    }

    function removeFileFromArray(fileNo) {

        fileObject = fileObject.filter(function (value, index, arr) {
            return value.count !== fileNo;
        });
        console.log(fileObject);
        $('#selectedImageList').html(fileObject.map(e => e.listHtml).join(""));

    }

    var model = {};

    function getFieldDetails() {
        var supplierName = $('#txtSupplierName').val();
        var address = $('#txtAddress').val();
        var landline = $('#txtLandline').val(); 
        var mobile = $('#txtMobile').val();
        var openingBalance = $('#txtOpeningBalance').val();
        var currentBalance = $('#txtCurrentBalance').val();

        openingBalance = openingBalance === '' ? 0 : openingBalance;
        currentBalance = currentBalance === '' ? 0 : currentBalance;

        var filesList = [];
        for (var i = 0; i < fileObject.length; i++) {
            filesList.push({ "AttachmentName": fileObject[i].fileName, "AttachmentFile": fileObject[i].filesBase64 });
        }

        if (IsUpdate) {
            model = {
                "SupplierId": supplierId,
                "SupplierName": supplierName,
                "Address": address,
                "Landline": landline, 
                "Mobile": mobile,
                "OpeningBalance": parseFloat(openingBalance),
                "CurrentBalance": parseFloat(currentBalance),
                "SupplierAttachmentList": filesList

            };
            SaveChanges('Update');
        } else {
            model = { 
                "SupplierName": supplierName,
                "Address": address,
                "Landline": landline, 
                "Mobile": mobile,
                "OpeningBalance": parseFloat(openingBalance),
                "CurrentBalance": parseFloat(currentBalance),
                "SupplierAttachmentList": filesList,
//                "CreatedBy":localStorage.loggedUser
                "CreatedBy":4
            };
            SaveChanges('Create');
        }
    }

    function SaveChanges(type) {
        $.ajax({
            url: localStorage.apiLink + "api/Supplier/" + type,
            type: 'POST',
            data: JSON.stringify(model),
            contentType: 'application/json',
            success: function (data, textStatus, xhr) {
                if (data === true) {
                     
                    Swal.fire({
                        title: 'Success',
                        text: "Changes Saved Successfully!",
                        icon: 'success',
                        showCancelButton: false,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'OK!'
                    }).then((result) => {
                        if (result.value) {
                            window.location.replace(localStorage.apiLink + "Supplier/SupplierView");
                        }
                    });
                } else {
                    Swal.fire(
                        'Oops...',
                        'Something went wrong!',
                        'error'
                    );
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                const objArr = [
                    [xhr.responseJSON.errors.SupplierName, '#errorSupplierName'], 
                    [xhr.responseJSON.errors.Landline, '#errorLandline'], 
                    [xhr.responseJSON.errors.Mobile, '#errorMobile'],
                    [xhr.responseJSON.errors.OpeningBalance, '#errorOpeningBalance'],
                    [xhr.responseJSON.errors.CurrentBalance, '#errorCurrentBalance']
                ];

                for (let i = 0; i < objArr.length; i++) {
                    $(objArr[i][1]).html('');
                    if (objArr[i][0] != null) { 
                        for (let j = 0; j < objArr[i][0].length; j++) { 
                            $(objArr[i][1]).append(`<h6 class="mb-0 text-capitalize">${objArr[i][0][j]}</h6> \n`);
                        } 
                    }
                }
            }
        });
    }


</script>