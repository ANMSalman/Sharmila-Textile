
@{
    ViewData["Title"] = "Dashboard";
}

<nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top">
    <div class="container-fluid">
        <div class="navbar-wrapper">
            <nav aria-label="breadcrumb" role="navigation">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                </ol>
            </nav>
        </div>
        <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end">
            <form class="navbar-form">
                <div class="input-group no-border">
                    <input type="text" value="" class="form-control" placeholder="Search...">
                    <button type="button" class="btn btn-white btn-round btn-just-icon">
                        <i class="material-icons">search</i>
                        <div class="ripple-container"></div>
                    </button>
                </div>
            </form>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="material-icons">notifications</i>
                        @* <span class="notification">5</span> *@
                        <p class="d-lg-none d-md-block">
                            Some Actions
                        </p>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="#">Mike John responded to your email</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" href="#pablo" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="material-icons">person</i>
                        <p class="d-lg-none d-md-block">
                            Account
                        </p>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                        <a class="dropdown-item" href="#">Profile</a>
                        <a class="dropdown-item" href="#">Settings</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" asp-controller="Login" asp-action="Logout">Log out</a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                Sort By :
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button data-btn="1" id="dropDownSort" class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        This Week
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item dropDownSort" href="#" data-li="1">This Week</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="2">From a week till today</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="3">This Month</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="4">From a Month till today</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="5">Last Month</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="6">This year</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="7">From a year till today</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="8">Last Year</a>
                        <a class="dropdown-item dropDownSort" href="#" data-li="9">Custom Range</a>
                    </div>
                </div>
            </div>
            <div class="col-auto ml-3 display-4 dtpFromData">
                |
            </div>
            <div class="col-auto dtpFromData">
                <div class="form-group form-inline align-bottom">
                    <input type="date" class="form-control" id="dtpFromData" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                    <h5 class="ml-4 mr-4 mb-0 font-weight-bold">to</h5>
                    <input type="date" class="form-control" id="dtpToData" value="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")">
                </div>
            </div>
            <div class="col-auto ml-3  ">
                <button class="btn btn-success" id="btnFilter">
                    <i class="material-icons">filter_list</i> Filter
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <hr />
            </div>
        </div>

        <!---------------------------------------------Main Contents--------------------------------------------------------->
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-header card-header-info card-header-icon">
                        <div class="card-icon">
                            <i class="fa fa-bitcoin"> </i>
                        </div>
                        <p class="card-category">Current Total Collection Pending</p>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">
                            <img src="~/img/loading.gif" style="max-height: 41px;" class="d-none" />
                            <span id="lblCollectionPending"></span>
                        </h3>
                        <hr />
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-header card-header-warning card-header-icon">
                        <div class="card-icon">
                            <i class="material-icons">payment </i>
                        </div>
                        <p class="card-category">Current Total Payment Pending</p>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">
                            <img src="~/img/loading.gif" style="max-height: 41px;" class="d-none" />
                            <span id="lblPaymentPending"></span>
                        </h3>
                        <hr />
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-header card-header-rose card-header-icon">
                        <div class="card-icon">
                            <i class="material-icons">account_balance_wallet</i>
                        </div>
                        <p class="card-category">Current Total In-hand Cash</p>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">
                            <img src="~/img/loading.gif" style="max-height: 41px;" class="d-none" />
                            <span id="lblInHandTotalCash"></span>
                        </h3>
                        <hr />
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-header card-header-success card-header-icon">
                        <div class="card-icon">
                            <i class="fa fa-money"></i>
                        </div>
                        <p class="card-category">Current Total In-Hand Cheques</p>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">
                            <img src="~/img/loading.gif" style="max-height: 41px;" class="d-none" />
                            <span id="lblInHandTotalCheque"></span>
                        </h3>
                        <hr />
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-header card-header-danger card-header-icon">
                        <div class="card-icon">
                            <i class="fa fa-bank"></i>
                        </div>
                        <p class="card-category">Current Bank balance</p>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">
                            <img src="~/img/loading.gif" style="max-height: 41px;" class="d-none" />
                            <span id="lblCurrentBankBalance"></span>
                        </h3>
                        <hr />
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-chart card-header-danger">
                        <div class="ct-chart" id="avgBusChart"></div>
                    </div>
                    <div class="card-body">
                        <h4 class="card-title">Average business</h4>
                        <p class="card-category"><strong>Total Business for the day : </strong><span class="text-success hover-text"></span></p>

                    </div>
                    <div class="card-footer">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-chart card-header-warning">
                        <div class="ct-chart" id="paymentChart"></div>
                    </div>
                    <div class="card-body">
                        <h4 class="card-title">Payment</h4>
                        <p class="card-category"><strong>Total Payment for the day : </strong><span class="text-success hover-text-total"></span></p>
                        <p class="card-category"><strong>Total Accountable for the day : </strong><span class="text-success hover-text-accountable"></span></p>

                    </div>
                    <div class="card-footer">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-chart card-header-warning">
                        <div class="ct-chart" id="collectionChart"></div>
                    </div>
                    <div class="card-body">
                        <h4 class="card-title">Collection</h4>
                        <p class="card-category"><strong>Total Collection for the day : </strong><span class="text-success hover-text-total"></span></p>
                        <p class="card-category"><strong>Total Accountable for the day : </strong><span class="text-success hover-text-accountable"></span></p>

                    </div>
                    <div class="card-footer">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-chart card-header-warning">
                        <div class="ct-chart" id="expenseChart"></div>
                    </div>
                    <div class="card-body">
                        <h4 class="card-title">Expense</h4>
                        <p class="card-category"><strong>Total Expense for the day : </strong><span class="text-success hover-text-total"></span></p>
                        <p class="card-category"><strong>Total Accountable for the day : </strong><span class="text-success hover-text-accountable"></span></p>

                    </div>
                    <div class="card-footer">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card card-nav-tabs card-plain">
                    <div class="card-header card-header-primary">
                        <!-- colors: "header-primary", "header-info", "header-success", "header-warning", "header-danger" -->
                        <div class="nav-tabs-navigation">
                            <div class="nav-tabs-wrapper">
                                <ul class="nav nav-tabs" data-tabs="tabs">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#pnlAgingCustomers" data-toggle="tab">Aging Customers</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#pnlUpcomingOwnCheques" data-toggle="tab">Upcoming Own cheques</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body ">
                        <div class="tab-content">
                            <div class="tab-pane active" id="pnlAgingCustomers">

                                <div class="card mt-0">
                                    <div class="card-body p-4">
                                        <table id="dataTblAging" class="table table-striped w-100">
                                            <thead>
                                                <tr>
                                                    <th class="text-center">#</th>
                                                    <th>Customer Name</th>
                                                    <th>NIC</th>
                                                    <th>Home Address</th>
                                                    <th>Home Landline</th>
                                                    <th>Office Address</th>
                                                    <th>Office Landline</th>
                                                    <th>Mobile</th>
                                                    <th>Opening Balance</th>
                                                    <th>Current Balance</th>
                                                    <th>Date Created</th>
                                                    <th>Last Collection Date</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>

                            </div>
                            <div class="tab-pane" id="pnlUpcomingOwnCheques">
                                <div class="card mt-0">
                                    <div class="card-body p-4">
                                        <table id="dataTbl" class="table table-striped w-100">
                                            <thead>
                                                <tr>
                                                    <th class="text-center">#</th>
                                                    <th>Cheque Code</th>
                                                    <th>Bank</th>
                                                    <th>Branch</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Due Date</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    GetTrendsFromServer("AverageBusiness");
    GetTrendsFromServer("PaymentTrend");
    GetTrendsFromServer("CollectionTrend");
    GetTrendsFromServer("ExpenseTrend");
    LoadReports();

    var ownChequeTable;
    var agingCustomersTable;

    $(function () {
        ownChequeTable = $('#dataTbl');
        agingCustomersTable = $('#dataTblAging');


        GetUpcomingOwnCheques();
        GetAgingCustomers();


    });

    function GetUpcomingOwnCheques() {
        $.ajax({
            url: localStorage.apiLink + "api/Dashboard/UpcomingOwnCheque",
            type: 'GET',
            contentType: 'application/json',
            success: function (data, textStatus, xhr) {
                ownChequeTable.DataTable({
                    data: data,
                    columns: [
                        { data: "OwnChequeId" },
                        { data: "ChequeCode" },
                        { data: "Bank" },
                        { data: "Branch" },
                        { data: "Amount" },
                        { data: "Date" },
                        { data: "DueDate" }
                    ]
                });
                $('#dataTbl_filter').addClass("float-right");

            },
            error: function (xhr, textStatus, errorThrown) {
            }

        });
    }

    function GetAgingCustomers() {
        $.ajax({
            url: localStorage.apiLink + "api/Dashboard/AgingCustomers",
            type: 'GET',
            contentType: 'application/json',
            success: function (data, textStatus, xhr) {
                agingCustomersTable.DataTable({
                    data: data,
                    columns: [
                        { data: "CustomerId" },
                        { data: "CustomerName" },
                        { data: "NIC" },
                        { data: "HomeAddress" },
                        { data: "HomeLandline" },
                        { data: "OfficeAddress" },
                        { data: "OfficeLandline" },
                        { data: "Mobile" },
                        { data: "OpeningBalance" },
                        { data: "CurrentBalance" },
                        { data: "CreatedDate" },
                        { data: "LastCollectionDate" }
                    ],
                    "order": [[ 11, "asc" ]]
                });
                $('#dataTbl_filter').addClass("float-right");

            },
            error: function (xhr, textStatus, errorThrown) {
            }

        });
    }


    function GetTrendsFromServer(type) {

        $.ajax({
            url: localStorage.apiLink + "api/Dashboard/" + type,
            type: 'GET',
            contentType: 'application/json',
            success: function (data, textStatus, xhr) {
                if (type === "AverageBusiness") {
                    CreateAvgBusTrend(data);
                } else if (type === "PaymentTrend") {
                    CreateTrend(data, "#paymentChart");
                } else if (type === "CollectionTrend") {
                    CreateTrend(data, "#collectionChart");
                } else if (type === "ExpenseTrend") {
                    CreateTrend(data, "#expenseChart");
                }
            },
            error: function (xhr, textStatus, errorThrown) {
            }
        });
    }

    function CreateAvgBusTrend(data) {
        var day = [];
        var total = [];

        data.forEach(function (currentValue, index, arr) {

            day.push(currentValue.day.toString());
            total.push({ meta: currentValue.total, value: currentValue.total });

        });

        var chart = Chartist.Line('#avgBusChart', {
            labels: day,
            series: [total]
        }, {
            lineSmooth: window.Chartist.Interpolation.cardinal({
                tension: 0
            }),
            low: 0,
            high: Math.max(total),
            chartPadding: {
                top: 0,
                right: 0,
                bottom: 0,
                left: 0
            },
            axisY: {
                offset: 75
            }
        }).on("created",
            function (bar) {
                $(".ct-point").mouseenter(function (e) {
                    var offset = $(this).attr("ct:value");
                    var vf = $(this).closest('.card').find('.hover-text').text('Rs ' + offset + '/=');

                }).mouseleave(function () {
                });
            });
    }

    function CreateTrend(data, trendId) {
        var day = [];
        var total = [];
        var accountable = [];

        data.forEach(function (currentValue, index, arr) {

            day.push(currentValue.day.toString());
            total.push({ meta: "total", value: currentValue.total });
            accountable.push({ meta: "accountable", value: currentValue.accountable });

        });

        var chart = Chartist.Line(trendId, {
            labels: day,
            series: [
                total,
                accountable
            ]
        }, {
            lineSmooth: window.Chartist.Interpolation.cardinal({
                tension: 0
            }),
            low: 0,
            high: Math.max(total),
            chartPadding: {
                top: 0,
                right: 0,
                bottom: 0,
                left: 0
            },
            axisY: {
                offset: 75
            }
        }).on("created",
            function (bar) {
                $(".ct-point").mouseenter(function (e) {
                    var type = $(this).attr("ct:meta");
                    var offset = $(this).attr("ct:value");
                    if (type === "total") {
                        $(this).closest('.card').find('.hover-text-total').text('Rs ' + offset + '/=');
                    } else {
                        $(this).closest('.card').find('.hover-text-accountable').text('Rs ' + offset + '/=');
                    }

                }).mouseleave(function () {
                });
            });
    }


    var drpDownSort = 1;

    $('.dtpFromData').hide();

    $('.dropDownSort').click(function () {
        $(this).parent().siblings('.dropdown-toggle')
            .text($(this).text())
            .data('btn', $(this).data('li'));
        drpDownSort = $("#dropDownSort").data('btn');
        if (drpDownSort === 9) {
            $('.dtpFromData').show();
        } else {
            $('.dtpFromData').hide();
        }
    });

    function LoadReports() {
        GetFromServer("CollectionPending", $('#lblCollectionPending'));
        GetFromServer("PaymentPending", $('#lblPaymentPending'));
        GetFromServer("InHandTotalCash", $('#lblInHandTotalCash'));
        GetFromServer("InHandTotalCheque", $('#lblInHandTotalCheque'));
        GetFromServer("CurrentBankBalance", $('#lblCurrentBankBalance'));
    }

    function GetFromServer(type, labelType) {
        labelType.addClass("d-none");
        labelType.prev().removeClass("d-none");

        $.ajax({
            url: localStorage.apiLink + "api/Dashboard/" + type,
            type: 'POST',
            contentType: 'application/json',
            success: function (data, textStatus, xhr) {
                labelType.prev().addClass("d-none");
                labelType.removeClass("d-none");
                labelType.removeClass("text-danger");
                labelType.text(data.toFixed(2).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,"));
            },
            error: function (xhr, textStatus, errorThrown) {
                labelType.prev().addClass("d-none");
                labelType.removeClass("d-none");
                labelType.addClass("text-danger");
                labelType.text("Error...");
            }
        });
    }


</script>
<style>
    .ct-point:hover {
        cursor: pointer;
    }
</style>