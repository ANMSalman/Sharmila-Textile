@if (ViewBag.IsUpdate == "true") {
    @model Sharmila_Textile_WebApp.ViewModel.CustomerViewModel;
}

@{
    ViewData["Title"] = "CustomerDetailView";
}

<nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
    <div class="container-fluid">
        <div class="navbar-wrapper">
            <nav aria-label="breadcrumb" role="navigation">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="CustomerView">Customer</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@ViewBag.breadcumValue</li>
                </ol>
            </nav>
        </div>
        <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end">

            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="material-icons">notifications</i>
                        @* <span class="notification">5</span> *@
                        <p class="d-lg-none d-md-block">
                            Some Actions
                        </p>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="#">Mike John responded to your email</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" href="#" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="material-icons">person</i>
                        <p class="d-lg-none d-md-block">
                            Account
                        </p>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                        <a class="dropdown-item" href="#">Profile</a>
                        <a class="dropdown-item" href="#">Settings</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Log out</a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <hr />
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card h-100 ">
                    <div class="card-header card-header-primary">
                        <h4 class="card-title">Customer Details</h4>
                    </div>
                    <div class="card-body">
                        <div class="row h-100">
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtCustomerName">Customer Name</label>
                                    <input type="text" class="form-control" id="txtCustomerName" asp-for="CustomerName">
                                    <div class="text-danger" id="errorCustomerName"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtNic">Customer National IC</label>
                                    <input type="text" class="form-control" id="txtNic" asp-for="NIC">
                                    <div class="text-danger" id="errorNic"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtHomeAddress">Home Address</label>
                                    <input type="text" class="form-control" id="txtHomeAddress" asp-for="HomeAddress">
                                    <div class="text-danger" id="errorHomeAddress"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtHomeLandline">Home Landline</label>
                                    <input type="text" class="form-control" id="txtHomeLandline" asp-for="HomeLandline">
                                    <div class="text-danger" id="errorHomeLandline"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtOfficeAddress">Office Address</label>
                                    <input type="text" class="form-control" id="txtOfficeAddress" asp-for="OfficeAddress">
                                    <div class="text-danger" id="errorOfficeAddress"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtOfficeLandline">Office Landline</label>
                                    <input type="text" class="form-control" id="txtOfficeLandline" asp-for="OfficeLandline">
                                    <div class="text-danger" id="errorOfficeLandline"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtMobile">Mobile</label>
                                    <input type="text" class="form-control" id="txtMobile" asp-for="Mobile">
                                    <div class="text-danger" id="errorMobile"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtOpeningBalance">Opening Balance</label>
                                    <input type="number" class="form-control" id="txtOpeningBalance" asp-for="OpeningBalance">
                                    <div class="text-danger" id="errorOpeningBalance"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-3">
                                <div class="form-group">
                                    <label for="txtCurrentBalance">Current Balance</label>
                                    <input type="number" class="form-control" id="txtCurrentBalance" asp-for="CurrentBalance">
                                    <div class="text-danger" id="errorCurrentBalance"></div>
                                </div>
                            </div>

                            <div class="col-md-5 mt-3">
                                <input type="file" id="fileAttachment" class="d-none">
                                <label for="fileAttachment" class="btn btn-round btn-success btn-sm mt-0">
                                    <i class="fa fa-paperclip mr-1"></i> Upload File
                                </label>
                                <hr />
                                <div class="mt-3">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <td class="font-weight-bold" width="70%">File Name</td>
                                                <td class="font-weight-bold text-center" width="15%">View File</td>
                                                <td class="font-weight-bold text-center" width="15%">Remove</td>
                                            </tr>
                                        </thead>
                                        <tbody id="selectedImageList">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-12 mt-3">
                                <div class="row justify-content-end">
                                    <div class="col-auto form-inline" id="progressBar">
                                        <img src="~/img/progress.gif" style="max-height: 41px;" class="mr-3" />
                                        <h5 class="align-bottom mb-0">Please Wait....</h5>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-primary" onclick="getFieldDetails()">Submit</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>

    var fileObject = [];
    var fileCount = 0;
     
    $('#progressBar').hide();
    var IsUpdate = @ViewBag.IsUpdate;
    var customerId;

    @if (ViewBag.IsUpdate == "true") {
        @:customerId = @Model.CustomerId;
        var attachmentCount = false || Model.CustomerAttachmentList.Count > 0;
        if (attachmentCount) {
            foreach (var item in Model.CustomerAttachmentList) {

                @:var baseFile = '@Html.Raw(item.AttachmentFile)';
                @:populateFileObjectArray(baseFile, "@item.AttachmentName");
            }
        }
    }

    function populateFileObjectArray(base64String, fileName) {

        var listHtml = `
                        <tr>
                            <td class="  p-1">`+ fileName + `</td>
                            <td class="text-center p-1">
                                <button type="button" rel="tooltip" class="btn btn-info btn-sm" onclick="openFileInNewTab('`+base64String+`');">
                                    <i class="material-icons">visibility</i>
                                </button>
                            </td>
                            <td class="text-center p-1">
                                <button type="button" rel="tooltip" class="btn btn-danger btn-sm" onclick="removeFileFromArray(`+ fileCount + `)">
                                    <i class="material-icons">clear</i>
                                </button>
                            </td>
                        </tr>
                        `;
        var obj = { count: fileCount, filesBase64: base64String, listHtml: listHtml, fileName: fileName };
        fileObject.push(obj);

        $('#selectedImageList').html(fileObject.map(e => e.listHtml).join(""));
        fileCount++;
    }

    $('input[id="fileAttachment"]').change(function (e) {
        if (fileObject.length < 5) {
            populateFilesList(e.target.files[0]);
        } else {
            Swal.fire(
                'File Limit Reached!',
                'You cannot select more than 5 files!',
                'error'
            );
        }
    });

    function populateFilesList(file) {
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () {
            var filesBase64 = reader.result;

            var listHtml = `
                            <tr>
                                <td class="  p-1">`+ file.name + `</td>
                                <td class="text-center p-1">
                                    <button type="button" rel="tooltip" class="btn btn-info btn-sm" onclick="openFileInNewTab('`+filesBase64+`');">
                                        <i class="material-icons">visibility</i>
                                    </button>
                                </td>
                                <td class="text-center p-1">
                                    <button type="button" rel="tooltip" class="btn btn-danger btn-sm" onclick="removeFileFromArray(`+ fileCount + `)">
                                        <i class="material-icons">clear</i>
                                    </button>
                                </td>
                            </tr>
                            `;

            var obj = { count: fileCount, filesBase64: filesBase64, listHtml: listHtml, fileName: file.name };
            fileObject.push(obj);

            $('#selectedImageList').html(fileObject.map(e => e.listHtml).join(""));
            fileCount++;
        };
        reader.onerror = function (error) {
            console.log('Error: ', error);
        };
    }

    function openFileInNewTab(file) {
        window.open(file);
    }

    function removeFileFromArray(fileNo) {

        fileObject = fileObject.filter(function (value, index, arr) {
            return value.count !== fileNo;
        });
        console.log(fileObject);
        $('#selectedImageList').html(fileObject.map(e => e.listHtml).join(""));

    }

    var model = {};

    function getFieldDetails() {
        var customerName = $('#txtCustomerName').val();
        var nic = $('#txtNic').val();
        var homeAddress = $('#txtHomeAddress').val();
        var homeLandline = $('#txtHomeLandline').val();
        var officeAddress = $('#txtOfficeAddress').val();
        var officeLandline = $('#txtOfficeLandline').val();
        var mobile = $('#txtMobile').val();
        var openingBalance = $('#txtOpeningBalance').val();
        var currentBalance = $('#txtCurrentBalance').val();

        openingBalance = openingBalance === '' ? 0 : openingBalance;
        currentBalance = currentBalance === '' ? 0 : currentBalance;

        var filesList = [];
        for (var i = 0; i < fileObject.length; i++) {
            filesList.push({ "AttachmentName": fileObject[i].fileName, "AttachmentFile": fileObject[i].filesBase64 });
        }

        if (IsUpdate) {
            model = {
                "CustomerId": customerId,
                "CustomerName": customerName,
                "NIC": nic,
                "HomeAddress": homeAddress,
                "HomeLandline": homeLandline,
                "OfficeAddress": officeAddress,
                "OfficeLandline": officeLandline,
                "Mobile": mobile,
                "OpeningBalance": parseFloat(openingBalance),
                "CurrentBalance": parseFloat(currentBalance),
                "CustomerAttachmentList": filesList

            };
            SaveChanges('Update');
        } else {
            model = {
                "CustomerName": customerName,
                "NIC": nic,
                "HomeAddress": homeAddress,
                "HomeLandline": homeLandline,
                "OfficeAddress": officeAddress,
                "OfficeLandline": officeLandline,
                "Mobile": mobile,
                "OpeningBalance": parseFloat(openingBalance),
                "CurrentBalance": parseFloat(currentBalance),
                "CustomerAttachmentList": filesList,
                //                "CreatedBy":localStorage.loggedUser
                "CreatedBy":4
            };
            SaveChanges('Create');
        }
    }

    function SaveChanges(type) {
        $('#progressBar').show();
        $.ajax({
            url: localStorage.apiLink + "api/Customer/" + type,
            type: 'POST',
            data: JSON.stringify(model),
            contentType: 'application/json',
            success: function (data, textStatus, xhr) {
                $('#progressBar').hide();
                if (data === true) {
                    Swal.fire(
                        'Success',
                        'Changes Saved Successfully',
                        'success'
                    );
                    Swal.fire({
                        title: 'Success',
                        text: "Changes Saved Successfully!",
                        icon: 'success',
                        showCancelButton: false,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'OK!'
                    }).then((result) => {
                        if (result.value) {
                            window.location.replace(localStorage.apiLink + "Customer/CustomerView");
                        }
                    });
                } else {
                    Swal.fire(
                        'Oops...',
                        'Something went wrong!',
                        'error'
                    );
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $('#progressBar').hide();
                const objArr = [
                    [xhr.responseJSON.errors.CustomerName, '#errorCustomerName'],
                    [xhr.responseJSON.errors.NIC, '#errorNic'],
                    [xhr.responseJSON.errors.HomeLandline, '#errorHomeLandline'],
                    [xhr.responseJSON.errors.OfficeLandline, '#errorOfficeLandline'],
                    [xhr.responseJSON.errors.Mobile, '#errorMobile'],
                    [xhr.responseJSON.errors.OpeningBalance, '#errorOpeningBalance'],
                    [xhr.responseJSON.errors.CurrentBalance, '#errorCurrentBalance']
                ];

                for (let i = 0; i < objArr.length; i++) {
                    $(objArr[i][1]).html('');
                    $(objArr[i][1]).parent().removeClass('has-danger').addClass("has-success").find('span').text('done');
                    if (objArr[i][0] != null) {
                        $(objArr[i][1]).parent().find('span').remove();
                        for (let j = 0; j < objArr[i][0].length; j++) {
                            $(objArr[i][1]).append(`<h6 class="mb-0 text-capitalize">${objArr[i][0][j]}</h6> \n`);
                            $(objArr[i][1]).parent().removeClass('has-success').addClass("has-danger")
                                .append(`<span class="material-icons form-control-feedback">clear</span>`);

                        }
                    }
                }

            }
        });
    }


</script>